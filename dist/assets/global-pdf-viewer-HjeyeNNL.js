import{e as L,f as F,r as C,h as j,i as M}from"./firebase-config-CsUtaHqz.js";document.addEventListener("click",async e=>{const o=e.target.closest("a");if(!o)return;const n=o.getAttribute("href")||o.href||"";if(!n)return;const i=n.toLowerCase().includes(".pdf")||n.includes("firebasestorage.googleapis.com"),s=n.includes("pdf-viewer.html");if(i||s){e.preventDefault(),e.stopPropagation();let c=n;if(s){const f=new URLSearchParams(n.substring(n.indexOf("?")));c=decodeURIComponent(f.get("url")||n)}window.history.pushState({pdfOpen:!0},"",window.location.pathname),await P(c)}},!0);function z(e){try{const t=e;t.requestFullscreen?t.requestFullscreen():t.webkitRequestFullscreen?t.webkitRequestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.msRequestFullscreen&&t.msRequestFullscreen();let o=document.getElementById("ios-fullscreen-hack");o||(o=document.createElement("video"),o.id="ios-fullscreen-hack",o.style.cssText="position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none;",o.playsInline=!0,document.body.appendChild(o)),o.webkitEnterFullscreen&&o.webkitEnterFullscreen()}catch(t){console.warn("Fullscreen API failed",t)}}window.FirebaseCacheManager={async getFileSize(e){let t=e;if(e.includes("pdf-viewer.html")){const o=new URLSearchParams(e.substring(e.indexOf("?")));t=decodeURIComponent(o.get("url")||e)}if(!t.includes("firebasestorage.googleapis.com"))return null;try{const n=new URL(t).pathname.split("/o/");if(n.length>1){const i=decodeURIComponent(n[1]),s=L(F),c=C(s,i),w=(await M(c)).size;return w>=1024*1024?(w/(1024*1024)).toFixed(1)+"MB":Math.round(w/1024)+"KB"}}catch(o){console.warn("Failed to get Firebase metadata for size",o)}return null},async downloadPdfSafely(e,t,o){var i;if(!t)return;const n=e.innerHTML;try{e.disabled=!0,e.innerHTML='<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>',e.style.animation="spin 1s linear infinite",e.style.background="rgba(148, 163, 184, 0.15)",e.style.color="#94a3b8";let s=t;if(t.includes("pdf-viewer.html")){const y=new URLSearchParams(t.substring(t.indexOf("?")));s=decodeURIComponent(y.get("url")||t)}if(s.includes("firebasestorage.googleapis.com")){const h=new URL(s).pathname.split("/o/");if(h.length>1){const x=decodeURIComponent(h[1]),U=L(F),I=C(U,x);s=await j(I)}}window.showToast&&window.showToast(`Downloading ${o}...`,"info");const c=await fetch(s,{mode:"cors"});if(!c.ok)throw new Error(`Network response was not ok (${c.status})`);const f=c.headers.get("content-length"),w=f?parseInt(f,10):0;let r=0;const l=(i=c.body)==null?void 0:i.getReader();if(!l)throw new Error("Could not read response body");const p=[];for(;;){const{done:y,value:h}=await l.read();if(y)break;if(h)if(p.push(h),r+=h.length,w>0){const x=Math.round(r/w*100);e.innerHTML=`<span style="font-size:11px; font-weight:700;">${x}%</span>`,e.style.background="rgba(180, 83, 9, 0.2)",e.style.color="#fff",e.style.border="1px solid rgba(180, 83, 9, 0.4)"}else e.style.animation="spin 1.5s linear infinite"}const a=new Blob(p,{type:"application/pdf"}),d=new Response(a),g=await caches.open("jkssb-pdf-cache-v1"),u=s.split("?"),m=u[0].includes("firebasestorage")?u.join("?"):u[0];await g.put(m,d);const D=30*24*60*60*1e3,E=Date.now()+D,T=localStorage.getItem("jkssb_downloads"),R=T?JSON.parse(T):{};R[m]={name:o,expiresAt:E},localStorage.setItem("jkssb_downloads",JSON.stringify(R)),e.style.animation="none",e.style.border="none",e.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>',e.style.background="rgba(16, 185, 129, 0.15)",e.style.color="#10b981",e.style.cursor="default",e.disabled=!0,window.showToast&&window.showToast("Downloaded successfully âœ“","success")}catch(s){console.error("Download failed",s),window.showToast&&window.showToast("Download failed. Try again.","error"),e.style.animation="none",e.style.border="none",e.innerHTML='<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>',e.style.background="rgba(239, 68, 68, 0.15)",e.style.color="#ef4444",setTimeout(()=>{e.disabled=!1,e.innerHTML=n,e.style.background="var(--gradient-primary, #e07b2a)",e.style.color="#fff"},3e3)}}};async function P(e){if(document.getElementById("secure-pdf-master"))return;const t=document.createElement("div");t.id="secure-pdf-master",t.style.cssText=`
        position: fixed;
        inset: 0;
        z-index: 2147483647;
        background: #111;
        overflow-y: auto;
        overflow-x: auto; /* Allow horizontal pan */
        -webkit-overflow-scrolling: touch;
        user-select: none;
        -webkit-user-select: none;
        -webkit-touch-callout: none;
    `,t.className="strict-security-blur";const o=document.createElement("div");o.id="pdf-canvas-container",o.style.cssText=`
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        padding: 8px 0;
    `,t.appendChild(o);const n=document.createElement("button");n.innerHTML="Exit Viewer",n.style.cssText=`
        position: fixed;
        top: 16px;
        right: 16px;
        z-index: 2147483648;
        background: rgba(15, 23, 42, 0.85);
        color: white;
        border: 1px solid rgba(255,255,255,0.2);
        padding: 8px 16px;
        border-radius: 20px;
        font-family: 'Poppins', sans-serif;
        font-weight: 600;
        font-size: 13px;
        cursor: pointer;
        transition: opacity 0.3s ease;
        backdrop-filter: blur(4px);
    `,t.appendChild(n);let i;const s=()=>{n.style.opacity="1",clearTimeout(i),i=setTimeout(()=>{n.style.opacity="0"},3e3)};t.addEventListener("pointerdown",s),t.addEventListener("touchstart",s),s(),document.body.appendChild(t),z(t),n.addEventListener("click",c=>{c.preventDefault(),c.stopPropagation(),S()}),O(),await H(),await q(e,o)}function S(){var t;const e=document.getElementById("secure-pdf-master");e&&(e.innerHTML="",e.remove());try{document.fullscreenElement?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen()}catch{}(t=window.history.state)!=null&&t.pdfOpen&&window.history.back(),B()}window.addEventListener("popstate",e=>{document.getElementById("secure-pdf-master")&&S()});document.addEventListener("fullscreenchange",v);document.addEventListener("webkitfullscreenchange",v);document.addEventListener("mozfullscreenchange",v);document.addEventListener("MSFullscreenChange",v);function v(){const e=document;!(e.fullscreenElement||e.webkitIsFullScreen||e.mozFullScreen||e.msFullscreenElement)&&document.getElementById("secure-pdf-master")&&S()}const b=e=>{if(e.type==="contextmenu")return e.preventDefault(),!1;if(e.type==="keydown"){const t=e;if(t.key==="PrintScreen"||t.code==="PrintScreen"||t.ctrlKey&&["p","s","c","a"].includes(t.key.toLowerCase())||t.metaKey&&["p","s","c","a"].includes(t.key.toLowerCase())||t.key==="F12"||t.ctrlKey&&t.shiftKey&&t.key.toLowerCase()==="i")return e.preventDefault(),e.stopPropagation(),!1}},k=e=>e.preventDefault();function O(){window.addEventListener("contextmenu",b,{capture:!0}),window.addEventListener("keydown",b,{capture:!0}),window.addEventListener("dragstart",k,{capture:!0}),window.addEventListener("drop",k,{capture:!0})}function B(){window.removeEventListener("contextmenu",b,{capture:!0}),window.removeEventListener("keydown",b,{capture:!0}),window.removeEventListener("dragstart",k,{capture:!0}),window.removeEventListener("drop",k,{capture:!0})}async function H(){if(!window.pdfjsLib)return new Promise((e,t)=>{const o=document.createElement("script");o.src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js",o.onload=()=>{const n=window.pdfjsLib;n.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js",e()},o.onerror=t,document.body.appendChild(o)})}async function q(e,t){try{const o=document.createElement("div");o.style.cssText="color: white; margin-top: 40vh; font-family: Poppins, sans-serif; font-size: 16px;",o.innerHTML="Loading Document Securely...",t.appendChild(o);const n=window.pdfjsLib;let i=null,s=e;if(e.includes("firebasestorage.googleapis.com"))try{const l=new URL(e).pathname.split("/o/");if(l.length>1){const p=decodeURIComponent(l[1]),a=L(F),d=C(a,p);s=await j(d),console.log("[PDF Viewer] Fetched fresh Firebase token automatically.")}}catch(r){console.warn("[PDF Viewer] Could not refresh Firebase token, falling back to original URL.",r)}if("caches"in window)try{const r=e.split("?"),l=r[0].includes("firebasestorage")?r.join("?"):r[0],a=await(await caches.open("jkssb-pdf-cache-v1")).match(l,{ignoreSearch:!0});if(a){const d=await a.arrayBuffer();i=new Uint8Array(d)}}catch{}if(!i)try{const r=await fetch(s,{mode:"cors"});if(!r.ok)throw new Error(`Network response was not ok (${r.status})`);const l=await r.arrayBuffer();i=new Uint8Array(l)}catch(r){console.warn("Fetch failed, falling back to PDF.js native loader:",r)}const f=await(i?n.getDocument({data:i}):n.getDocument({url:s,withCredentials:!1})).promise;o.remove();const w=f.numPages;for(let r=1;r<=w;r++){const l=await f.getPage(r),p=window.devicePixelRatio||1;let a=l.getViewport({scale:1}),d=(window.innerWidth-12)/a.width;d>1.8&&(d=1.8),d<.5&&(d=.5),a=l.getViewport({scale:d});const g=document.createElement("div");g.style.cssText=`
                position: relative;
                margin-bottom: 8px;
                background: white;
                box-shadow: 0 4px 12px rgba(0,0,0,0.5);
                border-radius: 4px;
                overflow: hidden;
            `;const u=document.createElement("canvas"),m=u.getContext("2d");u.width=a.width*p,u.height=a.height*p,u.style.width=`${a.width}px`,u.style.height=`${a.height}px`,u.style.display="block",m.scale(p,p),g.appendChild(u),t.appendChild(g),await l.render({canvasContext:m,viewport:a}).promise}}catch(o){console.error("PDF Render Error",o);const n=(o==null?void 0:o.message)||(o==null?void 0:o.name)||String(o);t.innerHTML=`
            <div style="color:#ef4444; margin-top:30vh; font-family:Poppins; text-align:center; padding: 0 20px;">
                <h3>Failed to load document</h3>
                <p style="font-size: 13px; opacity: 0.8; word-break: break-all;">Error Details: ${n}</p>
                <p style="font-size: 12px; margin-top:20px;">(If this says "Network response was not ok" or "Failed to fetch", your Firebase Storage bucket is actively blocking this website. You must apply the CORS rules in Google Cloud Shell).</p>
            </div>
        `}}if(window.location.pathname.includes("pdf-viewer.html")){const t=new URLSearchParams(window.location.search).get("url");t&&(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>P(t)):P(t))}
