import{x as b,y as a,b as h,d as l,c as i,z as U,A,G as C,B as N,C as R,D as j,E as L,e as _,m as v,F}from"./firebase-config-BMA5n-tq.js";const P=async(e,s)=>{try{return{success:!0,user:(await j(a,e,s)).user}}catch(t){return{success:!1,error:t.message}}},W=async(e,s)=>{try{const t=await A(a,e,s);return await f(t.user.uid),{success:!0,user:t.user}}catch(t){return{success:!1,error:t.message}}},G=async()=>{try{const e=new C,s=await N(a,e);return await f(s.user.uid),{success:!0,user:s.user}}catch(e){return{success:!1,error:e.message}}},J=async e=>{try{return await R(a,e),{success:!0}}catch(s){return{success:!1,error:s.message}}},M=async()=>{try{return localStorage.removeItem("jkssb_auth_cache"),await U(a),{success:!0}}catch(e){return{success:!1,error:e.message}}};let c=null,k=!0;const K=(e,s=!1)=>{if(c&&!k&&(s||e(c)),!s&&!c){const t=localStorage.getItem("jkssb_auth_cache");if(t)try{c=JSON.parse(t),e(c)}catch{}}return b(a,t=>{if(k=!1,c=t,t){const r={uid:t.uid,email:t.email,photoURL:t.photoURL,displayName:t.displayName};localStorage.setItem("jkssb_auth_cache",JSON.stringify(r))}else localStorage.removeItem("jkssb_auth_cache");e(t)})},V=()=>a.currentUser,q=async(e,s)=>{var t;try{const r=l(i,"users",e.uid),u=await _(r),m=((t=e.providerData[0])==null?void 0:t.providerId)||"email",n={email:e.email,photoURL:e.photoURL||null,provider:m,lastLogin:v()};if(u.exists())s!=null&&s.name?n.name=s.name:e.displayName&&(n.name=e.displayName);else{n.name=(s==null?void 0:s.name)||e.displayName||"",n.createdAt=v();try{const d=l(i,"metadata","counters"),E=await F(i,async y=>{var I;const S=await y.get(d);let p=0;S.exists()&&(p=((I=S.data())==null?void 0:I.userCount)||0);const w=p+1;return y.set(d,{userCount:w},{merge:!0}),String(w).padStart(3,"0")});n.userId=E}catch(d){console.warn("Failed to generate sequential ID, defaulting to fallback.",d)}}await h(r,n,{merge:!0});const T={uid:e.uid,email:e.email,photoURL:e.photoURL,displayName:n.name};return localStorage.setItem("jkssb_auth_cache",JSON.stringify(T)),{success:!0}}catch(r){return{success:!1,error:r.message}}},g="jkssb_session_token",f=async e=>{try{const s=crypto.randomUUID?crypto.randomUUID():Date.now().toString()+Math.random().toString(36).slice(2);localStorage.setItem(g,s);const t=l(i,"users",e);return await h(t,{sessionToken:s},{merge:!0}),localStorage.setItem("jkssb_login_time",Date.now().toString()),s}catch(s){return console.error("Failed to setup session token:",s),null}};let o=null;const z=e=>{o&&clearInterval(o),o=setInterval(async()=>{var t;try{const r=localStorage.getItem(g);if(!r)return;const u=await _(l(i,"users",e));if(!u.exists())return;const m=(t=u.data())==null?void 0:t.sessionToken;m&&m!==r&&(console.warn("Session mismatch detected! Another device logged in."),clearInterval(o),localStorage.removeItem(g),await U(a),window.location.href="./login.html?error=session_conflict")}catch(r){console.warn("Session verifier check failed (network issue?):",r)}},15*1e3)},B=()=>{o&&(clearInterval(o),o=null)},D=async e=>{try{localStorage.removeItem(g),await h(l(i,"users",e),{sessionToken:null},{merge:!0})}catch{}},Y=async e=>{try{return(await L(a,e)).length>0}catch{return!1}},$=f;export{B as a,W as b,D as c,G as d,P as e,Y as f,V as g,q as h,z as i,$ as j,K as o,J as r,M as s};
