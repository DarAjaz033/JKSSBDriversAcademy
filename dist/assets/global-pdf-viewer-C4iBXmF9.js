import{i as D,j as R,r as A,g as M,k as z}from"./firebase-config-BMA5n-tq.js";document.addEventListener("click",async t=>{const e=t.target;if(e.closest(".secure-download-btn"))return;const o=e.closest("a");if(!o)return;const i=o.getAttribute("href")||o.href||"";if(!i)return;const s=i.toLowerCase().includes(".pdf")||i.includes("firebasestorage.googleapis.com"),l=i.includes("pdf-viewer.html");if(s||l){t.preventDefault(),t.stopPropagation();let d=i;if(l){const p=new URLSearchParams(i.substring(i.indexOf("?")));d=decodeURIComponent(p.get("url")||i)}window.history.pushState({pdfOpen:!0},"",window.location.pathname),await E(d)}},!0);function B(t){try{const e=t;e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.msRequestFullscreen&&e.msRequestFullscreen();let o=document.getElementById("ios-fullscreen-hack");o||(o=document.createElement("video"),o.id="ios-fullscreen-hack",o.style.cssText="position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none;",o.playsInline=!0,document.body.appendChild(o)),o.webkitEnterFullscreen&&o.webkitEnterFullscreen()}catch(e){console.warn("Fullscreen API failed",e)}}window.FirebaseCacheManager={async getFileSize(t){let e=t;if(t.includes("pdf-viewer.html")){const o=new URLSearchParams(t.substring(t.indexOf("?")));e=decodeURIComponent(o.get("url")||t)}if(!e.includes("firebasestorage.googleapis.com"))return null;try{const i=new URL(e).pathname.split("/o/");if(i.length>1){let s=decodeURIComponent(i[1]);s=s.split("?")[0];const l=D(R),d=A(l,s),b=(await z(d)).size;return b>=1024*1024?(b/(1024*1024)).toFixed(1)+"MB":Math.round(b/1024)+"KB"}}catch(o){console.warn("Failed to get Firebase metadata for size",o)}return null},async downloadPdfSafely(t,e,o){var s;if(!e)return;const i=t.innerHTML;try{t.disabled=!0,t.innerHTML='<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>',t.style.animation="spin 1s linear infinite",t.style.background="rgba(148, 163, 184, 0.15)",t.style.color="#94a3b8";let l=e;if(e.includes("pdf-viewer.html")){const n=new URLSearchParams(e.substring(e.indexOf("?")));l=decodeURIComponent(n.get("url")||e)}let d=l;if(d.includes("firebasestorage.googleapis.com")){const g=new URL(d).pathname.split("/o/");if(g.length>1){const w=decodeURIComponent(g[1]),P=D(R),C=A(P,w);d=await M(C)}}window.showToast&&window.showToast(`Downloading ${o}...`,"info");const p=await fetch(d,{mode:"cors"});if(!p.ok)throw new Error(`Network response was not ok (${p.status})`);const b=p.headers.get("content-length"),L=b?parseInt(b,10):0;let y=0;const r=(s=p.body)==null?void 0:s.getReader();if(!r)throw new Error("Could not read response body");const a=[];for(;;){const{done:n,value:g}=await r.read();if(n)break;if(g)if(a.push(g),y+=g.length,L>0){const w=Math.round(y/L*100);t.innerHTML=`<span style="font-size:11px; font-weight:700;">${w}%</span>`,t.style.background="rgba(180, 83, 9, 0.2)",t.style.color="#fff",t.style.border="1px solid rgba(180, 83, 9, 0.4)"}else t.style.animation="spin 1.5s linear infinite"}const c=new Blob(a,{type:"application/pdf"}),v=new Response(c),m=await caches.open("jkssb-pdf-cache-v1"),f=l.split("?")[0];await m.put(f,v);const k=30*24*60*60*1e3,u=Date.now()+k,h=localStorage.getItem("jkssb_downloads"),x=h?JSON.parse(h):{};x[f]={name:o,expiresAt:u},localStorage.setItem("jkssb_downloads",JSON.stringify(x)),t.style.animation="none",t.style.border="none",t.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>',t.style.background="rgba(16, 185, 129, 0.15)",t.style.color="#10b981",t.style.cursor="default",t.disabled=!0,window.showToast&&window.showToast("Downloaded successfully ✓","success")}catch(l){console.error("Download failed",l),window.showToast&&window.showToast("Download failed. Try again.","error"),t.style.animation="none",t.style.border="none",t.innerHTML='<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>',t.style.background="rgba(239, 68, 68, 0.15)",t.style.color="#ef4444",setTimeout(()=>{t.disabled=!1,t.innerHTML=i,t.style.background="var(--gradient-primary, #e07b2a)",t.style.color="#fff"},3e3)}}};async function E(t){if(document.getElementById("secure-pdf-master"))return;const e=document.createElement("div");e.id="secure-pdf-master",e.style.cssText=`
        position: fixed;
        inset: 0;
        z-index: 2147483647;
        background: #111;
        overflow-y: auto;
        overflow-x: auto; /* Allow horizontal pan */
        -webkit-overflow-scrolling: touch;
        user-select: none;
        -webkit-user-select: none;
        -webkit-touch-callout: none;
        mix-blend-mode: normal; /* Security anchor for screenshots */
    `,e.className="strict-security-blur";const o=document.createElement("div");o.id="pdf-canvas-container",o.style.cssText=`
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        padding: 8px 0;
    `,e.appendChild(o);const i=document.createElement("button");i.innerHTML="Exit Viewer",i.style.cssText=`
        position: fixed;
        top: 16px;
        right: 16px;
        z-index: 2147483648;
        background: rgba(15, 23, 42, 0.85);
        color: white;
        border: 1px solid rgba(255,255,255,0.2);
        padding: 8px 16px;
        border-radius: 20px;
        font-family: 'Poppins', sans-serif;
        font-weight: 600;
        font-size: 13px;
        cursor: pointer;
        transition: opacity 0.3s ease;
        backdrop-filter: blur(4px);
    `,e.appendChild(i),document.body.appendChild(e),B(e),i.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),j()});let s=1;const l=1,d=3,p=document.createElement("div");p.style.cssText=`
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 2147483648;
        display: flex;
        gap: 8px;
        background: rgba(15, 23, 42, 0.85);
        padding: 6px;
        border-radius: 8px;
        backdrop-filter: blur(4px);
        border: 1px solid rgba(255,255,255,0.2);
        transition: opacity 0.3s ease;
    `,("ontouchstart"in window||navigator.maxTouchPoints>0)&&(p.style.display="none");const L=`
        width: 36px; height: 36px; border-radius: 6px; border: none;
        background: rgba(255,255,255,0.1); color: white; font-size: 20px;
        font-weight: bold; cursor: pointer; display: flex;
        align-items: center; justify-content: center;
    `,y=document.createElement("button");y.innerHTML="−",y.style.cssText=L,y.onclick=n=>{n.stopPropagation(),s-=.25,a()};const r=document.createElement("button");r.innerHTML="+",r.style.cssText=L,r.onclick=n=>{n.stopPropagation(),s+=.25,a()},p.appendChild(y),p.appendChild(r),e.appendChild(p);const a=()=>{s<l&&(s=l),s>d&&(s=d),o.dataset.currentZoom=s.toString();const n=s<=l;y.disabled=n,y.style.opacity=n?"0.4":"1",y.style.cursor=n?"not-allowed":"pointer",o.querySelectorAll("canvas").forEach(w=>{if(w.dataset.baseWidth&&w.dataset.baseHeight){const P=parseFloat(w.dataset.baseWidth),C=parseFloat(w.dataset.baseHeight);w.style.width=`${P*s}px`,w.style.height=`${C*s}px`}})};e.addEventListener("wheel",n=>{(n.ctrlKey||n.metaKey)&&(n.preventDefault(),n.deltaY<0?s+=.1:s-=.1,a())},{passive:!1}),e.addEventListener("dblclick",()=>{s=1,a()});const c=document.createElement("div");c.style.cssText=`
        position: fixed; inset: 0; background: #000; z-index: 2147483649; 
        display: none; align-items: center; justify-content: center;
        color: #ef4444; font-family: Poppins, sans-serif; font-weight: bold; font-size: 20px;
    `,c.innerHTML="PDF Hidden (Focus Lost)",document.body.appendChild(c);const v=()=>{document.hidden||!document.hasFocus()?(c.style.display="flex",e.style.opacity="0"):(c.style.display="none",e.style.opacity="1")};window.addEventListener("blur",v),window.addEventListener("focus",v),document.addEventListener("visibilitychange",v);const m=()=>{if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)try{navigator.setCaptureOptions&&navigator.setCaptureOptions({secure:!0})}catch{}};setInterval(m,3e3),m();let f=0,k=1;e.addEventListener("touchstart",n=>{n.touches.length===2&&(f=Math.hypot(n.touches[0].clientX-n.touches[1].clientX,n.touches[0].clientY-n.touches[1].clientY),k=s)}),e.addEventListener("touchmove",n=>{if(n.touches.length===2){n.preventDefault();const g=Math.hypot(n.touches[0].clientX-n.touches[1].clientX,n.touches[0].clientY-n.touches[1].clientY);s=k*(g/f),a()}},{passive:!1});let u=0;e.addEventListener("touchend",n=>{const g=new Date().getTime(),w=g-u;w<300&&w>0&&n.changedTouches.length===1&&(s=1,a()),u=g}),a();let h;const x=()=>{i.style.opacity="1",p.style.opacity="1",clearTimeout(h),h=setTimeout(()=>{i.style.opacity="0",p.style.opacity="0"},3e3)};e.addEventListener("pointerdown",x),e.addEventListener("touchstart",x),x(),I(),await H(),await U(t,o)}function j(){var o;const t=document.getElementById("secure-pdf-master");t&&(t.innerHTML="",t.remove());try{document.fullscreenElement?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen()}catch{}(o=window.history.state)!=null&&o.pdfOpen&&window.history.back(),O();const e=document.querySelector('div[style*="PDF Hidden"]');e&&e.remove()}window.addEventListener("popstate",t=>{document.getElementById("secure-pdf-master")&&j()});document.addEventListener("fullscreenchange",S);document.addEventListener("webkitfullscreenchange",S);document.addEventListener("mozfullscreenchange",S);document.addEventListener("MSFullscreenChange",S);function S(){const t=document;!(t.fullscreenElement||t.webkitIsFullScreen||t.mozFullScreen||t.msFullscreenElement)&&document.getElementById("secure-pdf-master")&&j()}const T=t=>{if(t.type==="contextmenu")return t.preventDefault(),!1;if(t.type==="keydown"){const e=t;if(e.key==="PrintScreen"||e.code==="PrintScreen"||e.altKey&&(e.key==="PrintScreen"||e.code==="PrintScreen")||e.metaKey&&(e.key==="PrintScreen"||e.code==="PrintScreen")||e.ctrlKey&&(e.key==="PrintScreen"||e.code==="PrintScreen")||e.ctrlKey&&["p","s","c","a","u"].includes(e.key.toLowerCase())||e.metaKey&&["p","s","c","a","u"].includes(e.key.toLowerCase())||e.key==="F12"||e.ctrlKey&&e.shiftKey&&["i","j","c","k"].includes(e.key.toLowerCase())||e.metaKey&&e.altKey&&["i","j","c","k"].includes(e.key.toLowerCase()))return t.preventDefault(),t.stopPropagation(),document.body.style.display="none",setTimeout(()=>{document.body.style.display=""},2e3),!1}},F=t=>t.preventDefault();function I(){window.addEventListener("contextmenu",T,{capture:!0}),window.addEventListener("keydown",T,{capture:!0}),window.addEventListener("dragstart",F,{capture:!0}),window.addEventListener("drop",F,{capture:!0})}function O(){window.removeEventListener("contextmenu",T,{capture:!0}),window.removeEventListener("keydown",T,{capture:!0}),window.removeEventListener("dragstart",F,{capture:!0}),window.removeEventListener("drop",F,{capture:!0})}async function H(){if(!window.pdfjsLib)return new Promise((t,e)=>{const o=document.createElement("script");o.src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js",o.onload=()=>{const i=window.pdfjsLib;i.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js",t()},o.onerror=e,document.body.appendChild(o)})}async function U(t,e){try{const o=document.createElement("div");o.style.cssText="color: white; margin-top: 40vh; font-family: Poppins, sans-serif; font-size: 16px;",o.innerHTML="Loading Document Securely...",e.appendChild(o);const i=window.pdfjsLib;let s=t;if(t.includes("firebasestorage.googleapis.com"))try{const a=new URL(t).pathname.split("/o/");if(a.length>1){const c=decodeURIComponent(a[1]),v=D(R),m=A(v,c);s=await M(m),console.log("[PDF Viewer] Fetched fresh Firebase token automatically.")}}catch(r){console.warn("[PDF Viewer] Could not refresh Firebase token, falling back to original URL.",r)}const l=s.split("?")[0];let d=null;try{const r=await caches.open("jkssb-pdf-cache-v1"),a=await r.match(l);if(a)d=await a.arrayBuffer(),window.showToast&&window.showToast("Opened instantly from secure cache ✓","success");else{const c=await fetch(s,{mode:"cors"});if(!c.ok)throw new Error("Failed to fetch PDF from network");r.put(l,c.clone()),d=await c.arrayBuffer()}}catch(r){console.warn("Cache bypass/fail:",r),d=await(await fetch(s,{mode:"cors"})).arrayBuffer()}const b=await i.getDocument({data:d}).promise;o.remove();const L="JKSSB Drivers Academy",y=b.numPages;for(let r=1;r<=y;r++){const a=await b.getPage(r),c=window.devicePixelRatio||1;let v=a.getViewport({scale:1}),m=(window.innerWidth-12)/v.width;m>1.8&&(m=1.8),m<.5&&(m=.5);let f=a.getViewport({scale:m});const k=document.createElement("div");k.style.cssText=`
                position: relative;
                margin - bottom: 8px;
                background: white;
                box - shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
                border - radius: 4px;
                overflow: hidden;
                `;const u=document.createElement("canvas"),h=u.getContext("2d");u.width=f.width*c,u.height=f.height*c,u.toDataURL=()=>"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",u.toBlob=n=>{n(null)};const x=parseFloat(e.dataset.currentZoom||"1.0");u.style.width=`${f.width*x}px`,u.style.height=`${f.height*x}px`,u.style.display="block",u.style.pointerEvents="none",u.dataset.baseWidth=f.width.toString(),u.dataset.baseHeight=f.height.toString(),h.scale(c,c),k.appendChild(u),e.appendChild(k),await a.render({canvasContext:h,viewport:f}).promise,h.save(),h.translate(f.width/2,f.height/2),h.font=`bold ${f.width*.065}px Poppins, sans-serif`,h.fillStyle="rgba(150, 150, 150, 0.25)",h.textAlign="center",h.textBaseline="middle",h.fillText(L,0,0),h.restore()}}catch(o){console.error("PDF Render Error",o);const i=(o==null?void 0:o.message)||(o==null?void 0:o.name)||String(o);e.innerHTML=`
            <div style="color:#ef4444; margin-top:30vh; font-family:Poppins; text-align:center; padding: 0 20px;">
                <h3>Failed to load document</h3>
                <p style="font-size: 13px; opacity: 0.8; word-break: break-all;">Error Details: ${i}</p>
                <p style="font-size: 12px; margin-top:20px;">(If this says "Network response was not ok" or "Failed to fetch", your Firebase Storage bucket is actively blocking this website. You must apply the CORS rules in Google Cloud Shell).</p>
            </div>
        `}}if(window.location.pathname.includes("pdf-viewer.html")){const e=new URLSearchParams(window.location.search).get("url");e&&(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>E(e)):E(e))}
