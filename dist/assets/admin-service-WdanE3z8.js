import{b as h,c as u,a,g as l,d,q as y,w as p,j as g,s as f,u as w,k as C,r as P,l as b,m as O,n as F,h as N}from"./firebase-config-CsUtaHqz.js";const D="jkssb_courses_cache",R="jkssb_pdfs_cache",x=10*60*1e3,S=()=>{localStorage.removeItem(D),localStorage.removeItem(R)},T="users",J=async s=>{if(!s)return!1;try{const e=await l(d(a,T,s.uid));if(e.exists())return e.data().role==="admin";if(s.email){const r=y(u(a,T),p("email","==",s.email)),t=await h(r);if(!t.empty)return t.docs[0].data().role==="admin"}return!1}catch{return!1}},H=async s=>{try{const r=(await h(u(a,"courses"))).docs.reduce((c,o)=>{const n=o.data().rank;return typeof n=="number"&&n>c?n:c},0),t=await g(u(a,"courses"),{...s,rank:s.rank??r+1,createdAt:f(),updatedAt:f()});return S(),{success:!0,id:t.id}}catch(e){return{success:!1,error:e.message}}},L=async(s,e)=>{try{const r=d(a,"courses",s);return await w(r,{rank:e,updatedAt:f()}),S(),{success:!0}}catch(r){return{success:!1,error:r.message}}},$=async(s,e)=>{try{const r=d(a,"courses",s);return await w(r,{...e,updatedAt:f()}),S(),{success:!0}}catch(r){return{success:!1,error:r.message}}},B=async s=>{try{return await C(d(a,"courses",s)),S(),{success:!0}}catch(e){return{success:!1,error:e.message}}},_=async()=>{try{const s=await h(u(a,"courses")),e=[];return s.forEach(r=>{e.push({id:r.id,...r.data()})}),e.sort((r,t)=>(r.rank??9999)-(t.rank??9999)),localStorage.setItem(D,JSON.stringify({data:e,timestamp:Date.now()})),{success:!0,courses:e}}catch(s){return{success:!1,error:s.message}}},K=async()=>{try{const s=localStorage.getItem(D);if(s){const{data:e,timestamp:r}=JSON.parse(s);if(Date.now()-r<x)return setTimeout(_,0),{success:!0,courses:e}}return await _()}catch(s){return{success:!1,error:s.message}}},U=async s=>{try{const e=await l(d(a,"courses",s));return e.exists()?{success:!0,course:{id:e.id,...e.data()}}:{success:!1,error:"Course not found"}}catch(e){return{success:!1,error:e.message}}},k=async()=>{try{const s=await h(u(a,"pdfs")),e=[];return s.forEach(r=>{e.push({id:r.id,...r.data()})}),localStorage.setItem(R,JSON.stringify({data:e,timestamp:Date.now()})),{success:!0,pdfs:e}}catch(s){return{success:!1,error:s.message}}},M=async()=>{try{const s=localStorage.getItem(R);if(s){const{data:e,timestamp:r}=JSON.parse(s);if(Date.now()-r<x)return setTimeout(k,0),{success:!0,pdfs:e}}return await k()}catch(s){return{success:!1,error:s.message}}},Y=(s,e,r)=>new Promise(t=>{const o=`${Date.now()}_${s.name}`,n=P(b,`pdfs/${o}`),I=F(n,s);I.on("state_changed",i=>{const m=Math.round(i.bytesTransferred/i.totalBytes*100);r==null||r(m)},i=>t({success:!1,error:i.message}),async()=>{try{const i=await N(I.snapshot.ref),m=await g(u(a,"pdfs"),{name:s.name,url:i,size:s.size,courseId:e,uploadedAt:f()}),q=d(a,"courses",e),A=await l(q);if(A.exists()){const E=A.data().pdfIds??[];E.includes(m.id)||await w(q,{pdfIds:[...E,m.id],updatedAt:f()})}t({success:!0,id:m.id,url:i})}catch(i){t({success:!1,error:i.message})}})}),v=async(s,e,r)=>{try{try{const o=P(b,e);await O(o)}catch{}await C(d(a,"pdfs",s));const t=d(a,"courses",r),c=await l(t);if(c.exists()){const o=c.data().pdfIds??[];await w(t,{pdfIds:o.filter(n=>n!==s),updatedAt:f()})}return{success:!0}}catch(t){return{success:!1,error:t.message}}},Q=async s=>{try{const e=y(u(a,"practiceTests"),p("courseId","==",s)),r=await h(e),t=[];return r.forEach(c=>{t.push({id:c.id,...c.data()})}),{success:!0,tests:t}}catch(e){return{success:!1,error:e.message}}},W=async s=>{try{return{success:!0,id:(await g(u(a,"practiceTests"),{...s,createdAt:f()})).id}}catch(e){return{success:!1,error:e.message}}},G=async()=>{try{const s=await h(u(a,"practiceTests")),e=[];return s.forEach(r=>{e.push({id:r.id,...r.data()})}),{success:!0,tests:e}}catch(s){return{success:!1,error:s.message}}},V=async s=>{try{return await C(d(a,"practiceTests",s)),{success:!0}}catch(e){return{success:!1,error:e.message}}},X=async s=>{try{return{success:!0,id:(await g(u(a,"purchases"),{...s,purchasedAt:f()})).id}}catch(e){return{success:!1,error:e.message}}},j=async s=>{try{const e=y(u(a,"purchases"),p("userId","==",s)),r=await h(e),t=[];return r.forEach(c=>{t.push({id:c.id,...c.data()})}),{success:!0,purchases:t}}catch(e){return{success:!1,error:e.message}}},Z=async()=>{try{const s=await h(u(a,"purchases")),e=[];return s.forEach(r=>{e.push({id:r.id,...r.data()})}),{success:!0,purchases:e}}catch(s){return{success:!1,error:s.message}}},ss=async(s,e)=>{try{const r=y(u(a,"purchases"),p("userId","==",s),p("courseId","==",e),p("status","==","completed"));return{success:!0,hasPurchased:!(await h(r)).empty}}catch(r){return{success:!1,error:r.message}}},es=async s=>{var e;try{const r=await j(s);if(!r.success)return r;const t=((e=r.purchases)==null?void 0:e.filter(o=>o.status==="completed").map(o=>o.courseId))||[],c=[];for(const o of t){const n=await U(o);n.success&&n.course&&c.push(n.course)}return{success:!0,courses:c}}catch(r){return{success:!1,error:r.message}}};export{U as a,M as b,X as c,Q as d,es as e,G as f,K as g,ss as h,J as i,Z as j,H as k,B as l,L as m,v as n,V as o,W as p,Y as q,$ as u};
