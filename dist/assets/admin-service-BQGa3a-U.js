import{b as d,c as n,a,j as g,s as f,g as w,d as h,q as y,w as p,u as S,k as D,r as _,l as k,m as O,n as U,h as F}from"./firebase-config-D0UifA0H.js";const I="jkssb_courses_cache",A="jkssb_pdfs_cache",b=600*1e3,C=()=>{localStorage.removeItem(I),localStorage.removeItem(A)},x="users",J=async e=>{if(!e)return!1;try{const s=await w(h(a,x,e.uid));if(s.exists())return s.data().role==="admin";if(e.email){const r=y(n(a,x),p("email","==",e.email)),t=await d(r);if(!t.empty)return t.docs[0].data().role==="admin"}return!1}catch{return!1}},H=async e=>{try{const r=(await d(n(a,"courses"))).docs.reduce((c,o)=>{const u=o.data().rank;return typeof u=="number"&&u>c?u:c},0),t=await g(n(a,"courses"),{...e,rank:e.rank??r+1,createdAt:f(),updatedAt:f()});return C(),{success:!0,id:t.id}}catch(s){return{success:!1,error:s.message}}},L=async(e,s)=>{try{const r=h(a,"courses",e);return await S(r,{rank:s,updatedAt:f()}),C(),{success:!0}}catch(r){return{success:!1,error:r.message}}},$=async(e,s)=>{try{const r=h(a,"courses",e);return await S(r,{...s,updatedAt:f()}),C(),{success:!0}}catch(r){return{success:!1,error:r.message}}},v=async e=>{try{return await D(h(a,"courses",e)),C(),{success:!0}}catch(s){return{success:!1,error:s.message}}},P=async()=>{try{const e=await d(n(a,"courses")),s=[];return e.forEach(r=>{s.push({id:r.id,...r.data()})}),s.sort((r,t)=>(r.rank??9999)-(t.rank??9999)),localStorage.setItem(I,JSON.stringify({data:s,timestamp:Date.now()})),{success:!0,courses:s}}catch(e){return{success:!1,error:e.message}}},B=async()=>{try{const e=localStorage.getItem(I);if(e){const{data:s,timestamp:r}=JSON.parse(e);if(Date.now()-r<b)return setTimeout(P,0),{success:!0,courses:s}}return await P()}catch(e){return{success:!1,error:e.message}}},N=async e=>{try{const s=await w(h(a,"courses",e));return s.exists()?{success:!0,course:{id:s.id,...s.data()}}:{success:!1,error:"Course not found"}}catch(s){return{success:!1,error:s.message}}},T=async()=>{try{const e=await d(n(a,"pdfs")),s=[];return e.forEach(r=>{s.push({id:r.id,...r.data()})}),localStorage.setItem(A,JSON.stringify({data:s,timestamp:Date.now()})),{success:!0,pdfs:s}}catch(e){return{success:!1,error:e.message}}},K=async()=>{try{const e=localStorage.getItem(A);if(e){const{data:s,timestamp:r}=JSON.parse(e);if(Date.now()-r<b)return setTimeout(T,0),{success:!0,pdfs:s}}return await T()}catch(e){return{success:!1,error:e.message}}},M=(e,s,r)=>new Promise(t=>{const o=`${Date.now()}_${e.name}`,u=_(k,`pdfs/${o}`),l=U(u,e);l.on("state_changed",i=>{const m=Math.round(i.bytesTransferred/i.totalBytes*100);r?.(m)},i=>t({success:!1,error:i.message}),async()=>{try{const i=await F(l.snapshot.ref),m=await g(n(a,"pdfs"),{name:e.name,url:i,size:e.size,courseId:s,uploadedAt:f()}),R=h(a,"courses",s),q=await w(R);if(q.exists()){const E=q.data().pdfIds??[];E.includes(m.id)||await S(R,{pdfIds:[...E,m.id],updatedAt:f()})}t({success:!0,id:m.id,url:i})}catch(i){t({success:!1,error:i.message})}})}),Y=async(e,s,r)=>{try{try{const o=_(k,s);await O(o)}catch{}await D(h(a,"pdfs",e));const t=h(a,"courses",r),c=await w(t);if(c.exists()){const o=c.data().pdfIds??[];await S(t,{pdfIds:o.filter(u=>u!==e),updatedAt:f()})}return{success:!0}}catch(t){return{success:!1,error:t.message}}},Q=async e=>{try{const s=y(n(a,"practiceTests"),p("courseId","==",e)),r=await d(s),t=[];return r.forEach(c=>{t.push({id:c.id,...c.data()})}),{success:!0,tests:t}}catch(s){return{success:!1,error:s.message}}},V=async e=>{try{return{success:!0,id:(await g(n(a,"practiceTests"),{...e,createdAt:f()})).id}}catch(s){return{success:!1,error:s.message}}},W=async()=>{try{const e=await d(n(a,"practiceTests")),s=[];return e.forEach(r=>{s.push({id:r.id,...r.data()})}),{success:!0,tests:s}}catch(e){return{success:!1,error:e.message}}},G=async e=>{try{return await D(h(a,"practiceTests",e)),{success:!0}}catch(s){return{success:!1,error:s.message}}},X=async e=>{try{return{success:!0,id:(await g(n(a,"purchases"),{...e,purchasedAt:f()})).id}}catch(s){return{success:!1,error:s.message}}},Z=async e=>{try{const s=y(n(a,"enrollments"),p("userId","==",e),p("status","==","active")),r=await d(s),t=[],c=new Date;return r.forEach(o=>{const u=o.data();let l=!0;if(u.expiresAt){const i=u.expiresAt.toDate?u.expiresAt.toDate():new Date(u.expiresAt);c>i&&(l=!1)}l&&u.courseId&&t.push(u.courseId)}),{success:!0,enrolledIds:t}}catch(s){return{success:!1,error:s.message,enrolledIds:[]}}},j=async e=>{try{const s=y(n(a,"purchases"),p("userId","==",e)),r=await d(s),t=[];return r.forEach(c=>{t.push({id:c.id,...c.data()})}),{success:!0,purchases:t}}catch(s){return{success:!1,error:s.message}}},ss=async()=>{try{const e=await d(n(a,"purchases")),s=[];return e.forEach(r=>{s.push({id:r.id,...r.data()})}),{success:!0,purchases:s}}catch(e){return{success:!1,error:e.message}}},es=async(e,s)=>{try{const r=y(n(a,"purchases"),p("userId","==",e),p("courseId","==",s),p("status","==","completed"));return{success:!0,hasPurchased:!(await d(r)).empty}}catch(r){return{success:!1,error:r.message}}},rs=async e=>{try{const s=await j(e);if(!s.success)return s;const r=s.purchases?.filter(c=>c.status==="completed").map(c=>c.courseId)||[],t=[];for(const c of r){const o=await N(c);o.success&&o.course&&t.push(o.course)}return{success:!0,courses:t}}catch(s){return{success:!1,error:s.message}}};export{N as a,K as b,X as c,Q as d,rs as e,Z as f,B as g,es as h,J as i,W as j,ss as k,H as l,v as m,L as n,Y as o,G as p,V as q,M as r,$ as u};
